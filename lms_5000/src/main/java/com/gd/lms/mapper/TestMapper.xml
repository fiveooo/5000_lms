<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gd.lms.mapper.TestMapper">
	<select id="selectTestLecture" resultType="map">
		SELECT
			l.lecture_no,
			l.semester_no,
			p.pro_name,
			s.subject_name
		FROM lecture l INNER JOIN subject s ON l.subject_no = s.subject_no
		INNER JOIN professor p ON p.user_id = l.user_id
		ORDER BY l.subject_no
	</select>
	
	<!-- 강좌별 시험리스트 생성 쿼리 -->
	<select id="selectTestList" resultType="com.gd.lms.vo.Test">
		SELECT 
			t.test_no testNo
			, t.test_name testName
			, t.test_starttime testStarttime
			, t.test_endtime testEndtime
			, t.test_createdate testCreatedate
			, t.test_updatedate testUpdatedate
			, t.lecture_no lectureNo
			, (
				SELECT ifnull(SUM(answer_score),0)
				FROM answer a
				INNER JOIN question q
				ON a.question_no = q.question_no
				WHERE q.test_no = t.test_no AND a.sign_no = #{signNo}
			) score
		FROM test t
		WHERE lecture_no = #{lectureNo}
				
	</select>	
	
	<!-- 시험별 문제 리스트 생성 쿼리 -->
	<select id="selectTestQuestion" resultType="com.gd.lms.vo.Question">
		SELECT 
			question_no questionNo
			, question_content questionContent
			, question_answer questionAnswer
			, test_no testNo
		FROM question
		WHERE test_no = #{testNo}
		ORDER BY question_no
	</select>
	
	<!-- 시험별 보기 리스트 생성 쿼리 -->
	<select id="selectTestChoice" resultType="com.gd.lms.vo.MultiChoice">
		SELECT
		choice_no choiceNo
		, question_no questionNo
		, choice_content choiceContent
		from multi_choice
		WHERE question_no IN (
			SELECT question_no
			FROM question q
			WHERE test_no = #{testNo}
			ORDER BY q.question_no
			)
		order by question_no, choice_no
	</select>
	
	<!-- 시험 데이터 삽입 쿼리 -->
	<insert id="insertTest" parameterType="com.gd.lms.vo.Test" useGeneratedKeys="true" keyProperty="testNo">
	insert 
		into test (
			test_name
			, test_starttime
			, test_endtime
			, test_createdate
			, test_updatedate
			, lecture_no
		) values (
			#{testName}
			, #{testStarttime}
			, #{testEndtime}
			, now()
			, now()
			, #{lectureNo}
		
		)
	</insert>
	
	<!-- 시험 문제 데이터 삽입 쿼리 -->
	<insert id="insertTestQuestion" parameterType="com.gd.lms.vo.Question" useGeneratedKeys="true" keyProperty="questionNo">
	insert 
		into question (
			question_content
			, question_answer
			, test_no
		) values (
			#{questionContent}
			, #{questionAnswer}
			, #{testNo}		
		)
	</insert>
	
	<!-- 시험 문제 보기 데이터 삽입 쿼리 -->
	<insert id="insertTestChoice" parameterType="com.gd.lms.vo.MultiChoice">
	insert 
		into multi_choice (
			choice_no 
			, question_no
			, choice_content
		) values (
			#{choiceNo}
			, #{questionNo}
			, #{choiceContent}
		)
	</insert>
	
	<!-- 시험 응시 여부 확인 -->
	<select id="selectTestCheck" resultType="int">
	SELECT
		Count(s.user_id) cnt
	from answer a
	INNER JOIN sign s
	ON a.sign_no = s.sign_no
	INNER JOIN user u
	ON s.user_id = u.user_id
	inner JOIN question q
	ON a.question_no = q.question_no
	INNER JOIN test t
	ON q.test_no = t.test_no
	WHERE u.user_id = #{userId} AND t.test_no = #{TestNo}
	
	</select>
	
	<!-- 학생 수강 -->
	<select id="selectSignNo" resultType="int">
	SELECT sign_no
		from sign
		WHERE 
			user_id = #{userId}  
		AND 
			lecture_no=(
				SELECT lecture_no
					FROM test s
					WHERE test_no = #{testNo})
	</select>
	
	
	<!-- 학생 답안 제출 쿼리-->
	<insert id="insertAnswer">
	INSERT
		INTO answer(
			answer_select
			, answer_score
			, question_no
			, sign_no
		) VALUES(
			#{answerSelect}
			, 0
			, #{questionNo}
			, #{signNo}		
		)
	</insert>
	
	<!-- 시험 제출 학생 리스트 생성 쿼리 -->
	<select id="selectTestStudnet" resultType="map">
	SELECT
		st.user_id studentId
		, st.st_name studentName
		, (
			SELECT ifnull(SUM(answer_score),0)
			FROM answer a
			INNER JOIN question q
			ON a.question_no = q.question_no
			WHERE q.test_no=#{testNo} and a.sign_no = s.sign_no
		) studentScore
	FROM sign s
	INNER JOIN student st
	ON s.user_id = st.user_id
	WHERE s.lecture_no = #{lectureNo};
	</select>
	

	
</mapper>